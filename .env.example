# ============================================================================
# COMMUNIQUE ENVIRONMENT CONFIGURATION
# ============================================================================
# Last updated: 2025-01 (Post-Cloudflare Migration)
# This file contains ONLY variables actively used by the codebase.
# See docs/development/quickstart.md for setup instructions.
# ============================================================================


# ============================================================================
# CORE DATABASE
# ============================================================================

# PostgreSQL Database
# Required for all environments
#
# Local development (docker compose up):
#   DATABASE_URL="postgresql://communique:communique@localhost:5432/communique"
#
# Managed (Neon/pgvector):
#   DATABASE_URL="postgresql://user:password@host:5432/database?sslmode=require"
#   DIRECT_URL="postgresql://user:password@host:5432/database"  # bypasses pgbouncer
#
DATABASE_URL="postgresql://communique:communique@localhost:5432/communique"

# Test Database (used by integration tests)
# Created automatically by docker/init-db.sql
TEST_DATABASE_URL=postgresql://test:test@localhost:5432/test


# ============================================================================
# AUTHENTICATION & SECURITY
# ============================================================================

# JWT Secret (Required)
# Used for email verification tokens and one-time tokens
# Generate with: openssl rand -hex 32
JWT_SECRET=your-jwt-secret-here

# Email Verification Secret (Optional, falls back to JWT_SECRET)
EMAIL_VERIFICATION_SECRET=your-email-verification-secret

# Identity Hash Salt (Required for identity verification)
# CRITICAL: Generate once, NEVER regenerate in production (requires data migration)
# Used for Sybil-resistant identity hashing (one-identity-per-account)
# Generate with: openssl rand -hex 32
IDENTITY_HASH_SALT=your-64-char-hex-salt-here-keep-secret-never-regenerate

# Identity Commitment Salt (Required for identity verification)
# CRITICAL: Generate once, NEVER regenerate in production (invalidates all commitments + nullifiers)
# Used to prevent offline passport enumeration against on-chain nullifiers
# Generate with: openssl rand -hex 32
IDENTITY_COMMITMENT_SALT=your-64-char-hex-salt-here-keep-secret-never-regenerate

# Entropy Encryption Key (Required for identity verification)
# AES-256-GCM key for encrypting user_entropy at rest in the database
# CRITICAL: Generate once, NEVER regenerate in production (breaks re-verification flow)
# Generate with: openssl rand -hex 32
ENTROPY_ENCRYPTION_KEY=your-64-char-hex-key-here-keep-secret-never-regenerate

# IP Hash Salt (Required for fraud detection)
# Used for privacy-preserving IP logging with daily rotation
# Can be regenerated safely (daily rotation built in)
# Generate with: openssl rand -hex 32
IP_HASH_SALT=your-64-char-hex-salt-here-keep-secret-safe-to-regenerate

# Submission Anonymization Salt (Required for privacy-preserving submissions)
# SHA-256(user_id + salt) → pseudonymous_id — breaks link between auth identity and on-chain proofs
# NEVER regenerate in production (breaks pseudonymous_id continuity)
# Generate with: openssl rand -hex 32
SUBMISSION_ANONYMIZATION_SALT=your-64-char-hex-salt-here-keep-secret-never-regenerate

# Cron Job Authentication (Required for scheduled tasks)
# Used to authenticate requests to /api/cron/* endpoints
# Generate with: openssl rand -hex 32
CRON_SECRET=your-cron-secret-here


# ============================================================================
# OAUTH PROVIDERS (Required for social login)
# ============================================================================

# OAuth Redirect Base URL
# Production: https://communi.email
# Development: http://localhost:5173
OAUTH_REDIRECT_BASE_URL=http://localhost:5173

# Google OAuth (https://console.cloud.google.com/apis/credentials)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Facebook OAuth (https://developers.facebook.com/apps)
FACEBOOK_CLIENT_ID=your-facebook-client-id
FACEBOOK_CLIENT_SECRET=your-facebook-client-secret

# Twitter/X OAuth (https://developer.twitter.com/portal)
TWITTER_CLIENT_ID=your-twitter-client-id
TWITTER_CLIENT_SECRET=your-twitter-client-secret

# LinkedIn OAuth (https://www.linkedin.com/developers/apps)
LINKEDIN_CLIENT_ID=your-linkedin-client-id
LINKEDIN_CLIENT_SECRET=your-linkedin-client-secret

# Discord OAuth (https://discord.com/developers/applications)
DISCORD_CLIENT_ID=your-discord-client-id
DISCORD_CLIENT_SECRET=your-discord-client-secret

# Coinbase OAuth (https://www.coinbase.com/settings/api)
# Highest trust score (90) due to KYC requirements
COINBASE_CLIENT_ID=your-coinbase-client-id
COINBASE_CLIENT_SECRET=your-coinbase-client-secret


# ============================================================================
# AI & MODERATION SERVICES
# ============================================================================

# GROQ API (Llama Guard 4 - Safety Moderation) - PRIMARY
# Get key from: https://console.groq.com/keys
# Used for: Content safety classification (MLCommons S1-S14 hazard taxonomy)
# FREE tier: 14,400 requests/day (~432K/month)
# Civic-critical categories: Elections (S13), Defamation (S5)
GROQ_API_KEY=your-groq-api-key-here

# Gemini API (Quality Assessment + AI Agents)
# Get key from: https://aistudio.google.com/apikey
# Used for: Message writing agent, subject line generation, quality moderation
# FREE tier: Unlimited in Google AI Studio
# Paid tier: $0.10/1M tokens (Flash-Lite)
GEMINI_API_KEY=your-gemini-api-key-here

# Exa Search API (Decision-Maker Person Lookup)
# Get key from: https://dashboard.exa.ai
# Used for: Searching for current holders of institutional positions and their contact info
# FREE tier: 2,000 searches/month
# Paid tier: $5/1k searches + $1/1k pages content
EXA_API_KEY=your-exa-api-key-here

# Voyage AI API (Vector Embeddings for Semantic Search)
# Get key from: https://dash.voyageai.com/
# Used for: Semantic search across intelligence and organizations
# FREE tier: 100M tokens/month for voyage-3-lite
# Paid tier: $0.06/1M tokens for voyage-3 (recommended)
VOYAGE_API_KEY=your-voyage-api-key-here

# OpenAI API (Embeddings + Scope Extraction) - OPTIONAL
# Get key from: https://platform.openai.com/api-keys
# Used for: LLM scope extraction fallback
# NOT used for content moderation (Llama Guard handles that)
# NOTE: Voyage AI is preferred for embeddings
OPENAI_API_KEY=your-openai-api-key-here


# ============================================================================
# CONGRESSIONAL INTEGRATION (CWC)
# ============================================================================

# Congress.gov API Key (Required for representative lookups)
# Get key from: https://api.congress.gov/sign-up/
CONGRESS_API_KEY=your-congress-api-key

# Google Civic Information API (Required for mDL district derivation)
# Used to map user addresses to congressional districts from mobile driver's licenses
# Get key from: https://console.cloud.google.com/apis/library/civicinfo.googleapis.com
GOOGLE_CIVIC_API_KEY=your-google-civic-api-key

# Senate CWC API (Communicating With Congress)
# Get credentials from congressional office partnership
CWC_API_BASE_URL=https://soapbox.senate.gov/api
CWC_API_KEY=your-cwc-api-key
CWC_CAMPAIGN_ID=communique-2025

# House CWC Integration (GCP Proxy)
# IMPORTANT: House CWC API requires IP whitelisting from Congress
# Apply at: https://www.house.gov/doing-business-with-the-house/communicating-with-congress-cwc
# Contact: CWCVendors@mail.house.gov
#
# Options for House delivery:
# 1. Direct API (requires whitelisted server IP) - not available in most deployments
# 2. GCP proxy server (requires proxy with whitelisted IP) - configure below
# 3. Contact forms (fallback - not yet implemented)
#
# If not configured, House submissions will FAIL with clear error messages
# (Senate submissions work without proxy - they use CWC_API_KEY above)
GCP_PROXY_URL=http://your-whitelisted-proxy-server:8080
GCP_PROXY_AUTH_TOKEN=your-gcp-proxy-auth-token

# CWC Delivery Agent Configuration
# These identify Communique as the delivery agent to Congress
CWC_DELIVERY_AGENT_ID=COMMUNIQUE_PBC
CWC_DELIVERY_AGENT_NAME="Communiqué PBC"
CWC_DELIVERY_AGENT_CONTACT=hello@communi.email
CWC_DELIVERY_AGENT_ACKNOWLEDGEMENT_EMAIL=noreply@communi.email
CWC_DELIVERY_AGENT_ACK=Y

# CWC Production Toggle (Optional, default: sandbox mode)
# When 'true': sends to /messages/ (real Senate endpoint — messages are delivered)
# When unset or 'false': sends to /testing-messages/ (sandbox — messages are not delivered)
# IMPORTANT: Do NOT set to 'true' in development — it will send real messages to Congress
CWC_PRODUCTION=false

# ============ Witness Encryption ============
# X25519 keypair for encrypting/decrypting witness data (address + proof inputs)
# Generate with: npx tsx scripts/generate-witness-keypair.ts
WITNESS_ENCRYPTION_PUBLIC_KEY=0x_generate_with_script
WITNESS_ENCRYPTION_PRIVATE_KEY=0x_generate_with_script


# ============================================================================
# IDENTITY VERIFICATION
# ============================================================================

# Didit.me SDK (Identity verification provider)
# Get credentials from: https://dashboard.didit.me/
DIDIT_API_KEY=your-didit-api-key-here
DIDIT_WORKFLOW_ID=your-didit-workflow-id-here
DIDIT_WEBHOOK_SECRET=your-didit-webhook-secret-here

# self.xyz SDK Configuration (Zero-knowledge passport verification)
# self.xyz uses on-chain verification, no API key required
# Server-side configuration
SELF_APP_NAME=Communiqué
SELF_SCOPE=communique-congressional
SELF_MOCK_PASSPORT=false

# Verification endpoint (must match frontend QR code generation)
SELF_ENDPOINT=https://communi.email/api/identity/verify


# ============================================================================
# VOTER PROTOCOL INTEGRATION
# ============================================================================

# Shadow Atlas API (registration + cell proofs)
# Production (docker-compose): http://shadow-atlas:3001
# Development: http://localhost:3000
SHADOW_ATLAS_API_URL=http://localhost:3000

# Shadow Atlas registration auth token
# Must match REGISTRATION_AUTH_TOKEN on the shadow-atlas server
# Generate with: openssl rand -hex 32
SHADOW_ATLAS_REGISTRATION_TOKEN=

# voter-protocol API URL (Cloudflare Workers deployment — legacy)
# Production: https://reputation.voter.workers.dev
# Development: http://localhost:8787 (wrangler dev)
VOTER_API_URL=https://reputation.voter.workers.dev

# voter-protocol API Authentication
# Generate with: openssl rand -hex 32
VOTER_API_KEY=your-voter-protocol-api-key-here


# ============================================================================
# EMAIL ENRICHMENT (Optional)
# ============================================================================

# Hunter.io API (Email verification and finder)
# Get key from: https://hunter.io/api
# Used for: Email validation and domain search in decision-maker search
HUNTER_IO_API_KEY=your-hunter-io-api-key-here

# Clearbit API (Email enrichment)
# Get key from: https://clearbit.com/
# Used for: Email enrichment with company and profile data
CLEARBIT_API_KEY=your-clearbit-api-key-here


# ============================================================================
# TRUSTED EXECUTION ENVIRONMENT (TEE) - Optional
# ============================================================================
# TEE configuration for privacy-preserving computation
# Current target: AWS Nitro Enclaves (mock/Phase 2)
# Azure support is planned but not yet implemented

# ──────────────────────────────────────────────────────────────────────────
# AWS Nitro Enclaves Configuration
# ──────────────────────────────────────────────────────────────────────────
# Required for AWS Nitro TEE deployment
# Get credentials from: https://console.aws.amazon.com/iam/

AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your-aws-access-key-id
AWS_SECRET_ACCESS_KEY=your-aws-secret-access-key
AWS_ACCOUNT_ID=123456789012

# Nitro Enclave Instance Configuration
AWS_NITRO_INSTANCE_TYPE=c6a.xlarge
AWS_VPC_ID=vpc-xxxxx
AWS_SUBNET_ID=subnet-xxxxx
AWS_SECURITY_GROUP_IDS=sg-xxxxx,sg-yyyyy
AWS_IAM_INSTANCE_PROFILE=communique-nitro-role
AWS_ENCLAVE_BUCKET=communique-nitro-enclaves

# ──────────────────────────────────────────────────────────────────────────
# Azure Confidential Computing (Not yet implemented)
# ──────────────────────────────────────────────────────────────────────────
# Placeholder for future Azure TEE support
# AZURE_SUBSCRIPTION_ID=your-subscription-id
# AZURE_RESOURCE_GROUP=your-resource-group
# AZURE_REGION=eastus


# ============================================================================
# PUBLIC ENVIRONMENT VARIABLES (Client-side)
# ============================================================================

# ============================================================================
# BLOCKCHAIN INFRASTRUCTURE (Scroll L2) — Wave 15b
# ============================================================================

# Scroll RPC URL (public, used for client-side read queries)
PUBLIC_SCROLL_RPC_URL=https://rpc.scroll.io

# Scroll RPC URL (private, used for server-side relayer transactions)
# Use a dedicated RPC endpoint for reliability (Alchemy, Infura, or self-hosted)
# TESTNET: https://sepolia-rpc.scroll.io
# MAINNET: https://rpc.scroll.io (or Alchemy/Infura endpoint)
SCROLL_RPC_URL=https://sepolia-rpc.scroll.io

# DistrictGate contract address (deployed on Scroll)
# v4 Scroll Sepolia (bb.js keccak verifier) — UPDATE after mainnet deployment
DISTRICT_GATE_ADDRESS=0x0085DFAd6DB867e7486A460579d768BD7C37181e

# On-chain root registries (Scroll Sepolia v4)
# Used by admin scripts for root registration after tree builds
USER_ROOT_REGISTRY_ADDRESS=0x19318d473b07e622751Fb5047e7929833cE687c9
CELL_MAP_REGISTRY_ADDRESS=0xbe0970996F18D37F4E8d261E1d579702f74cf364
VERIFIER_REGISTRY_ADDRESS=0xe7B18F488E44eE33f5B7B0d73b3714716b88423d
NULLIFIER_REGISTRY_ADDRESS=0x4D9060de86Adf846786E32BaFe753D944496D00e
CAMPAIGN_REGISTRY_ADDRESS=0xcF02ae94AF65d1f4be79F5C64Db2c4C8aEABa512
DISTRICT_REGISTRY_ADDRESS=0x793516Ea1f9D2845F149684Fbe84f7Bb5C938AE1

# Engagement Root Registry (Three-Tree Architecture — not yet deployed)
ENGAGEMENT_ROOT_REGISTRY_ADDRESS=0x0000000000000000000000000000000000000000

# ZK Circuit depth (default: 20). Controls Merkle tree capacity (2^depth leaves).
# Valid values: 18, 20, 22, 24. Depth 20 covers all US states.
# Override for international expansion (larger trees need higher depth).
# This is a VITE_ var — exposed to browser-side prover-client.ts.
VITE_CIRCUIT_DEPTH=20

# Server relayer wallet private key (pays gas for on-chain verification)
# This wallet MUST be funded with ETH on Scroll for gas.
# Generate: cast wallet new | grep "Private key"
# Fund: bridge ETH to Scroll via bridge.scroll.io
# CRITICAL: Never commit this value. Use secrets manager in production.
SCROLL_PRIVATE_KEY=


# ============================================================================
# FEATURE FLAGS
# ============================================================================

# Beta features (default: false)
# Controls access to features in FeatureStatus.BETA
# Note: Only PUBLIC_ENABLE_BETA is actually used in the codebase
PUBLIC_ENABLE_BETA=false

# Analytics Configuration
# USE_SNAPSHOT_ONLY (default: true)
# When true: Queries use pre-noised snapshots (differential privacy enforced)
# When false: Queries can access raw aggregates (PRIVACY LEAK RISK)
# Production should ALWAYS be true
USE_SNAPSHOT_ONLY=true

# Rate Limiting Backend
# RATE_LIMIT_USE_DB (default: false)
# When true: Uses database for distributed rate limiting
# When false: Uses in-memory rate limiting (single instance only)
RATE_LIMIT_USE_DB=false

# Agent Trace Persistence (default: false)
# When true: Agent thoughts, completions, and costs are persisted to Postgres
# When false: No trace writes, no performance impact (console.log only)
# Data auto-expires after AGENT_TRACE_TTL_DAYS (default: 30)
AGENT_TRACE_ENABLED=false
AGENT_TRACE_CONTENT=false
AGENT_TRACE_TTL_DAYS=30


# ============================================================================
# DEVELOPMENT SETTINGS
# ============================================================================

# Node Environment
NODE_ENV=development

# Server Configuration (SvelteKit defaults)
PORT=5173
HOST=localhost

# Logging Level (debug | info | warn | error)
LOG_LEVEL=info

# Communique Production Stack
#
# Deploy on any VPS with Docker:
#   1. Copy this file + Caddyfile + .env.production to the server
#   2. Fill in .env.production with real values
#   3. docker compose -f docker-compose.production.yml up -d
#
# Requirements: 4GB RAM VPS minimum, Docker 24+, ports 80/443 open
# Estimated cost: $5-20/mo on Hetzner/Vultr/DigitalOcean

services:
  caddy:
    image: caddy:2-alpine
    container_name: communique-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      communique:
        condition: service_healthy
    restart: unless-stopped

  communique:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: communique-app
    env_file: .env.production
    environment:
      NODE_ENV: production
      PORT: "3000"
      DATABASE_URL: postgresql://communique:${DB_PASSWORD}@postgres:5432/communique
      DIRECT_URL: postgresql://communique:${DB_PASSWORD}@postgres:5432/communique
    expose:
      - "3000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "1.0"
    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg16
    container_name: communique-postgres
    environment:
      POSTGRES_USER: communique
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: communique
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../docker/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U communique"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "0.5"
    restart: unless-stopped

  shadow-atlas:
    build:
      context: ../../voter-protocol/packages/shadow-atlas
      dockerfile: Dockerfile
    container_name: communique-shadow-atlas
    environment:
      NODE_ENV: production
      PORT: "3001"
      HOST: "0.0.0.0"
      DB_PATH: /data/shadow-atlas.db
      IPFS_GATEWAY: http://ipfs:8080
    volumes:
      - shadow-atlas-data:/data
    expose:
      - "3001"
    depends_on:
      ipfs:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3001/v1/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "0.5"
    restart: unless-stopped

  ipfs:
    image: ipfs/kubo:latest
    container_name: communique-ipfs
    environment:
      IPFS_PROFILE: server
    volumes:
      - ipfs-data:/data/ipfs
    expose:
      - "5001"
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "ipfs id || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "0.5"
    restart: unless-stopped

volumes:
  caddy-data:
  caddy-config:
  pgdata:
  shadow-atlas-data:
  ipfs-data:
